#!/usr/bin/env groovy

pipeline {

    agent any

    parameters {
        choice(name: 'SERVICE', choices: ['Buslogic', 'Origination'], description: 'Select a service to deploy')
        booleanParam(defaultValue: true, name: 'KE', description: '')
        booleanParam(defaultValue: true, name: 'UG', description: '')
        booleanParam(defaultValue: true, name: 'ZM', description: '')
    }

//    tools {
//        jdk 'Coretto 17'
//    }

    options {
        disableConcurrentBuilds(abortPrevious: true)
        skipStagesAfterUnstable()
    }

    environment {
//        PROJECT_VERSION = "${readProperties(file: "${WORKSPACE}/gradle.properties").version}"
        PROJECT_VERSION = "6.0.1"
    }

    stages {

        stage('Build') {
            steps {
                echo ">>> Build version: ${env.PROJECT_VERSION}"
                script {
                    try {
                        sh 'chmod +x gradlew'
                        sh './gradlew build'
                    } finally {
                        junit '**/build/test-results/test/*.xml'
                        archiveArtifacts artifacts: '**/build/test-results/test/*.xml', allowEmptyArchive: true
                    }
                }
                archiveArtifacts artifacts: 'build/reports/changelog/**', allowEmptyArchive: true
            }
        }

        stage('Publish artifacts') {
            steps {
                echo '>>> Publish artifacts'
    			script {
    				sh 'chmod +x gradlew'
    				sh './gradlew publish'
    			}
            }
        }

        stage('Deploy Test') {
            steps {
                script {
                    sh 'chmod +x gradlew'
                    echo '>>> Deployment started'

                    if (params.KE) {
                        TASK = "deploy${params.SERVICE}KeDev"
                        echo ">>> Deploying to TEST using task: ${TASK}"
//                        sh "./gradlew ${TASK}"
                    }
                    if (params.UG) {
                        TASK = "deploy${params.SERVICE}UgDev"
                        echo ">>> Deploying to Test using task: ${TASK}"
//                        sh "./gradlew ${TASK}"
                    }
                    if (params.ZM) {
                        TASK = "deploy${params.SERVICE}ZmDev"
                        echo ">>> Deploying to Test using task: ${TASK}"
//                        sh "./gradlew ${TASK}"
                    }

                    echo '>>> Deployment finished'
                }
            }
        }

    }

	post {
		success {
            echo '>>> Sending success msg to Slack channel'
//			slackSend(
//					channel: "#unibos-build",
//					token: "Migrated slack token",
//					color: "good",
//					message: "local-services ${BRANCH_NAME} version ${env.PROJECT_VERSION} success"
//			)
		}
		failure {
            echo '>>> Sending failure msg to Slack channel'
//			slackSend(
//					channel: "#unibos-build",
//					token: "Migrated slack token",
//					color: "danger",
//					message: "local-services ${BRANCH_NAME} version ${env.PROJECT_VERSION} failed"
//			)
		}
	}
}